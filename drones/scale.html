<!DOCTYPE html>
<html>
  <head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
    <title>Drone Wars</title>
	<link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700" rel="stylesheet" type="text/css">
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js'></script>
    <script src='http://api.tiles.mapbox.com/mapbox.js/v0.6.6/mapbox.js'></script>
    <script src='http://underscorejs.org/underscore-min.js'></script>
    <link href='http://fonts.googleapis.com/css?family=Roboto:900,300,500' rel='stylesheet' type='text/css'>
    <link href='http://api.tiles.mapbox.com/mapbox.js/v0.6.6/mapbox.css' rel='stylesheet' />
    <link href='bootstrap.css' rel='stylesheet' />
    <link href='reset.css' rel='stylesheet' />
    <link href='style.css' rel='stylesheet' />
  </head>

  <body>
    <div id='map'>
</div>
  <script>
function fusionTables(id, callback) {

	function response(x) {
		var features = [];
		if (!x || !x.rows) return features;
		for (var i = 0; i < x.rows.length; i++) {
			var entry = x.rows[i];
			var summary = entry[12];
			var latitude = entry[13];
			var longitude = entry[14];
            var re = /^([^\-]{1,})-([^\-]+)-([^\-]+)$/;
            var dateStr = entry[3].replace(re, "$2 $1, 20$3");
			var str = entry[8]
            var minTotalDeaths = parseInt(str.split('-')[0]);
            if (str.split('-').length > 1) {
                var maxTotalDeaths = parseInt(str.split('-')[1]);
                var avgTotalDeaths = (minTotalDeaths + maxTotalDeaths)/2
            }
            else {
                var avgTotalDeaths = parseInt(str);
            }

			var feature = {
				geometry: {
					type: 'Point',
					coordinates: [parseFloat(entry[14]), parseFloat(entry[13])]
				},
				properties: {
					"title": entry[0],
                    "bid": entry[2],
                    "dateStr":dateStr,
					"avgTotalDeaths" : avgTotalDeaths,
					"description": "<h4>" + dateStr + "</h4><p>" + summary + "</p>"
				}
			};
			features.push(feature);
		}
		return callback(features);
	}
	var key = "AIzaSyATjmrN-_hALhmD62zhZLh4EanrmwT-mjE";
	var url = 'https://www.googleapis.com/fusiontables/v1/query?sql=SELECT%20*%20FROM%20' + id + '&key=' + key + '&typed=false&callback=jsonp';
	$.ajax({
		url: url,
		dataType: 'jsonp',
		jsonpCallback: 'jsonp',
		success: response,
		error: response
	});
}
var scale_factory_cache = {};
    function scale_factory(feature) {
    var dim = Math.round((feature.properties.avgTotalDeaths +1) * 1.5);
    if (!scale_factory_cache[dim]) {
        var c = document.createElement("canvas");
        c.width = dim;
        c.height = dim;
        var ctx = c.getContext("2d");
        ctx.fillStyle = "rgba(220, 20, 56, 0.6)";
        ctx.strokeStyle = "rgb(103,10,26)";
        ctx.beginPath();
        ctx.arc(dim/2, dim/2, dim/Math.PI, 0, Math.PI*2, true);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        scale_factory_cache[dim] = c.toDataURL();
    }
    var el = document.createElement("div");
    el.width = dim;
    el.height = dim;
    el.className = 'marker';
    el.id = feature.properties.title.replace(/[ ]{1,}/, '').toLowerCase() + feature.properties.bid.toLowerCase();
    el.style.cssText =
        "width:" + dim + "px;" +
        "height:" + dim + "px;" +
        "margin-left:" + (-dim/2) + "px;" +
        "margin-top:" + (-dim/2) + "px;" +
        "position:absolute";
    var ma = document.createElement("div");
    ma.className = 'drone-marker';
    el.appendChild(ma)
    var di = document.createElement("div");
    di.className = 'direction1';
    ma.appendChild(di)
    var di = document.createElement("div");
    di.className = 'direction2';
    ma.appendChild(di)
    return el;
    }

fusionTables('1dqxWkhKis38Lq5eLbzQz4gRRsH2ZROZXSn-Z0KQ', function(features) {
	features = _.map(features, function(f) {
		f.properties.title = f.properties.title
		f.properties.description = f.properties.description
		f.properties.date = f.properties.date
        f.properties.bid = f.properties.bid
        f.properties.dateStr = f.properties.dateStr
		return f;
	});
	var map = mapbox.map('map');
	mapbox.load('herwig.map-0g1xpajs', function(o) {
		map.addLayer(o.layer);
		map.setZoomRange(6, 12);
		map.ui.hash.add();
		map.zoom(8).center({
			lat: 32.604,
			lon: 69.791
		});
		var markerLayer = mapbox.markers.layer().factory(scale_factory).features(features)
		map.addLayer(markerLayer)
		mapbox.markers.interaction(markerLayer).add()
	});
});
    </script>
  </body>
</html>